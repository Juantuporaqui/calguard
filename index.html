function confirmarDiasSeleccionados() {
    if (diasSeleccionados.length === 0) {
        alert("No has seleccionado ningún día.");
        return;
    }

    // Verificar si hay suficientes días libres acumulados
    if (diasSeleccionados.length > daysLibres) {
        alert("No tienes suficientes días libres acumulados.");
        return;
    }

    // Resta los días seleccionados del contador de días libres acumulados
    daysLibres -= diasSeleccionados.length;
    libresGastados += diasSeleccionados.length;

    // Actualiza el contador en la interfaz
    updateCounter();

    // Marca los días seleccionados como "libres" en el calendario y guárdalos en IndexedDB
    diasSeleccionados.forEach(dia => {
        dia.classList.add('libre');
        // Guardar cada día libre en IndexedDB
        almacenarInteraccionDia(dia.dataset.date, 'libre');
    });

    // Obtenemos las fechas seleccionadas utilizando formatDateShort
    const fechasSeleccionadas = diasSeleccionados.map(dia => formatDateShort(new Date(dia.dataset.date)));
    let diasPorAsignar = diasSeleccionados.length;
    let registroGuardiasDetalle = [];
    let mensajeWhatsAppDetalle = [];

    // Distribuir los días libres entre las guardias disponibles
    for (let guardia of guardiasRealizadas) {
        let diaGuardiaNumero = guardia.diasLibresUsados.length + 1;

        while (diasPorAsignar > 0 && guardia.diasLibresRestantes > 0) {
            guardia.diasLibresRestantes--;
            diasPorAsignar--;

            const diaAsignado = fechasSeleccionadas.shift();
            guardia.diasLibresUsados.push(diaAsignado);

            // Utilizamos formatDateShort para el guardia.fecha
            const fechaGuardia = formatDateShort(new Date(guardia.fecha));

            const registroTexto = `Día ${diaGuardiaNumero} de la guardia del ${fechaGuardia}: ${diaAsignado}`;
            registroGuardiasDetalle.push(registroTexto);
            mensajeWhatsAppDetalle.push(`Día ${diaGuardiaNumero} de la guardia del ${fechaGuardia}: ${diaAsignado}`);

            diaGuardiaNumero++;
        }
        if (diasPorAsignar === 0) {
            break;
        }
    }

    if (diasPorAsignar > 0) {
        alert("No hay suficientes guardias registradas para cubrir los días seleccionados.");
        return;
    }

    // Actualizar el registro con los días seleccionados y las guardias usadas
    registroLibrados.push(...registroGuardiasDetalle);

    // Actualizamos el registro en el div correspondiente
    updateRegistroLibrados();

    // Construimos el mensaje de WhatsApp
    let mensajeWhatsApp = `Buenos días Paco, qué tal? Me gustaría librar los siguientes días:\n${mensajeWhatsAppDetalle.join('\n')}`;

    // Mostrar el popup para confirmar el envío
    mostrarPopupWhatsApp(mensajeWhatsApp);
}

function mostrarPopupWhatsApp(mensaje) {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.innerHTML = `
        <div class="popup-content">
            <p><strong>Mensaje para enviar:</strong></p>
            <textarea rows="4" cols="40" readonly>${mensaje}</textarea>
            <br>
            <button id="aceptarButton">Aceptar</button>
            <button id="cancelarButton">Cancelar</button>
        </div>
    `;

    document.body.appendChild(popup);

    // Asignar eventos a los botones
    document.getElementById('aceptarButton').onclick = function () {
        enviarWhatsApp(mensaje);
        closePopup();
    };
    document.getElementById('cancelarButton').onclick = function () {
        closePopup();
    };
}

function enviarWhatsApp(mensaje) {
    const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`;
    window.open(url, '_blank');
}

function closePopup() {
    const popup = document.querySelector('.popup');
    if (popup) {
        popup.remove();
    }
}

function resetDayClickHandlers() {
    document.querySelectorAll('.day').forEach((dia) => {
        dia.onclick = function (event) {
            const dayElement = event.target;
            const monthIndex = parseInt(dayElement.dataset.date.split('-')[1]) - 1;
            const dayNumber = parseInt(dayElement.innerText);
            showDropdownMenu(event, dayElement, monthIndex, dayNumber);
        };
    });
}
